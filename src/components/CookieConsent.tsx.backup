
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Cookie, Settings, BarChart3 } from "lucide-react";
import { useAuth } from "@/contexts/AuthContext";
import { useUserPreferences } from "@/hooks/useUserPreferences";
import { toast } from 'sonner';

const CookieConsent = () => {
  const { isAuthenticated, user } = useAuth();
  const { 
    preferences, 
    loading, 
    shouldShowCookieConsent, 
    updateCookieConsent, 
    hasConsent 
  } = useUserPreferences();
  const navigate = useNavigate();

  const handleAccept = async () => {
    try {
      await updateCookieConsent(true);
      toast.success('Cookie preferences saved');
    } catch (error) {
      console.error('Error saving cookie consent:', error);
      toast.error('Failed to save preferences');
    }
  };

  const handleDecline = async () => {
    try {
      await updateCookieConsent(false);
      toast.success('Cookie preferences saved');
    } catch (error) {
      console.error('Error saving cookie consent:', error);
      toast.error('Failed to save preferences');
    }
  };

  const handleCustomize = () => {
    // Navigate to preferences page or open preferences modal
    navigate('/profile?tab=preferences');
  };

  const handlePrivacyPolicy = () => {
    navigate('/privacy-policy');
  };

  // Don't show banner if user is not authenticated, loading, or shouldn't show consent
  if (!isAuthenticated || loading || !shouldShowCookieConsent) {
    return null;
  }

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <Card className="bg-white shadow-2xl border border-brand-green max-w-2xl mx-auto animate-in fade-in-0 zoom-in-95 duration-300">
        <CardContent className="p-6">
          <div className="flex items-start gap-4">
            <div className="flex gap-2">
              <Cookie className="w-6 h-6 text-brand-green mt-1 flex-shrink-0" />
              <BarChart3 className="w-6 h-6 text-brand-green mt-1 flex-shrink-0" />
            </div>
            <div className="flex-1">
              <h3 className="font-semibold text-lg mb-2 text-gray-900">Welcome to FoodVrse! ðŸŽ‰</h3>
              <p className="text-sm text-gray-700 mb-4 leading-relaxed">
                We use cookies and analytics to enhance your experience, provide personalized content, 
                and help us improve our service. This helps us understand how you use our platform 
                and deliver better features for food waste reduction.
              </p>
              <p className="text-sm text-gray-600 mb-4">
                <button 
                  onClick={handlePrivacyPolicy}
                  className="text-brand-green hover:text-brand-green/80 underline bg-transparent border-none cursor-pointer font-medium"
                >
                  Learn more in our Privacy Policy
                </button>
              </p>
              <div className="flex flex-wrap gap-3">
                <Button 
                  onClick={handleAccept}
                  className="bg-gradient-to-r from-orange-500 to-red-500 text-white hover:from-orange-600 hover:to-red-600 font-medium"
                  size="sm"
                >
                  Accept All
                </Button>
                <Button 
                  onClick={handleCustomize}
                  variant="outline"
                  size="sm"
                  className="flex items-center gap-2 border-gray-300 text-gray-700 hover:bg-gray-50"
                >
                  <Settings className="w-4 h-4" />
                  Customize
                </Button>
                <Button 
                  onClick={handleDecline}
                  variant="ghost"
                  size="sm"
                  className="text-gray-600 hover:text-gray-800 font-medium"
                >
                  Decline
                </Button>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default CookieConsent;

